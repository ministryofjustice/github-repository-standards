# Ministry of Justice GitHub Repository Standards

[![repo standards badge](https://img.shields.io/endpoint?labelColor=231f20&color=005ea5&style=for-the-badge&label=MoJ%20Compliant&url=https%3A%2F%2Foperations-engineering-reports.cloud-platform.service.justice.gov.uk%2Fapi%2Fv1%2Fcompliant_public_repositories%2Fendpoint%2Fgithub-repository-standards&logo=data:image/png;base64,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)](https://operations-engineering-reports.cloud-platform.service.justice.gov.uk/public-github-repositories.html#github-repository-standards)

This repository queries the Ministry of Justice (MoJ) GitHub Org API to find all the non archived repositories, and checks whether or not they comply with our [standards](https://ministryofjustice.github.io/technical-guidance/#building-software).

These checks run on a regular schedule, and sends the results to the [Operations Engineering Reports](https://operations-engineering-reports.cloud-platform.service.justice.gov.uk/) web application.

## Repositories should:

- be MIT Licensed
- have `main` as the default branch
- have non-empty description (shouldn't be null or "")
- have issues enabled
- have branch protection on `main`, with:
  1. Require a pull request before merging
  2. Require approvals option and a minimum number of user to approve the pull request.
  3. Include administrators option

## Architecture

- A GraphQL query retrieves information about MoJ GitHub repositories
- Data for each repository is used to instantiate a `StandardsReport` object
- Code in `StandardsReport` creates a report based on the data supplied
- The data is saved to two files
- The two files are encrypted and sent to the Operations Engineering Reports web application.

## Documentation

Yard is used for documentation. It creates a html report within the `doc` folder:

```
gem install yard
yardoc 'lib/**/*.rb'
```

## Development

### Environment Variables

To run app from the terminal:

For the Ruby code:

- `ADMIN_GITHUB_TOKEN` must contain a GitHub personal access token (PAT) enabled for MoJ SSO

For the Python code:

- `OPERATIONS_ENGINEERING_REPORTS_API_KEY` is a shared key between this App and the [Operations Engineering Report](https://github.com/ministryofjustice/operations-engineering-reports), placed into the message header to verify the messages are from this App.
- `OPERATIONS_ENGINEERING_REPORTS_HOST` is the URL to the Operations Engineering Report on the Cloud Platform.
- `ENCRYPTION_KEY` a shared encryption key to encrypt the data in transit.

### bin/repository-checker

This script runs on daily basis via the [GitHub Actions workflow](https://github.com/ministryofjustice/github-repository-standards/actions/workflows/post-report-data.yml). You can also run it manually by triggering the action. This script will create the two files of data that are to be sent to the Operations Engineering Reports application.

To run it locally:

```
ruby bin/repository-checker
```

### scripts/python/encrypt_send_data.py

This script will encrypt and send the two files of data to the Operations Engineering Reports application.

To run it locally:

```
python3 -m venv venv
source venv/bin/activate
python3 -m pip install -r scripts/python/requirements.txt
python3 scripts/python/encrypt_send_data.py
```

### Tests

Install `bundler` (`gem install bundler`) then run `bundle install` to install the dependencies.

To run the unit tests use `bundle exec rspec` or `rspec`.

`rspec` will generate a code coverage report using simplecov and create a `coverage` folder. Open the report using `open coverage/index.html`

Install `rspec` and `ruby-debug-ide` (locally for VS-Code to debug the tests):

```
gem install rspec --install-dir ./bin
sudo gem install ruby-debug-ide
```

### VS Code Debugging

To debug in VS Code use the below launch configrations within `.vscode/launch.json`:

```
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Python",
      "type": "python",
      "python": "${workspaceFolder}/venv/bin/python3",
      "request": "launch",
      "cwd": "${workspaceRoot}",
      "program": "${workspaceFolder}/scripts/python/encrypt_send_data.py",
      "console": "integratedTerminal",
      "env": {
        "OPERATIONS_ENGINEERING_REPORTS_API_KEY": "THE_HEADER_API_KEY",
        "OPERATIONS_ENGINEERING_REPORTS_HOST": "THE_OPS_ENG_API_URL",
        "ENCRYPTION_KEY": "THE_ENCRYPTION_KEY"
      }
    },
    {
      "name": "Ruby - file",
      "type": "Ruby",
      "request": "launch",
      "program": "${workspaceRoot}/bin/repository-checker",
      "env": {
        "ADMIN_GITHUB_TOKEN": "add-token",
      }
    },
    {
      "name": "RSpec - file",
      "type": "Ruby",
      "request": "launch",
      "program": "${workspaceRoot}/bin/bin/rspec",
      "args": ["${file}"]
    },
    {
      "name": "RSpec - all",
      "type": "Ruby",
      "request": "launch",
      "program": "${workspaceRoot}/bin/bin/rspec",
      "args": ["-I", "${workspaceRoot}"]
    }
  ]
}
```
